<!DOCTYPE html>
<html>
<head>
<script>

var fs = require('fs');
var path = require('path');

const remote = require('electron').remote;
const xslt = require('./xslt.js');

const xmlOpt = '--xmlDir';
const dbgOpt = '--debug';

const createAddComponentMenuFilename = "../templates/cim_add_components_menu.xslt";
const createAttributeListFilename = "../templates/cim_xml_scheme.xslt";

const menuDir = "templates/menu/";
const attributeDir = "templates/attributes/";

var getOptions = function(args) {
  let options = {};
  for (let index = 1; index < args.length; index++) {
    keyPair = args[index].split('='); 
    if (keyPair.length == 2) {
      options[keyPair[0]] = keyPair[1];
    }
  }
  if (options[dbgOpt] == 'true') {
    for (let optionIndex in options){
      process.stderr.write("option: " + optionIndex + " = " + options[optionIndex] + "\n");
    }
  }
  return options;
};

var XSLTTranslation = function(xmlFile, options) {
  return xslt.performXSLTTranslationFilenames(xmlFile, createAttributeListFilename,
                                              createAddComponentMenuFilename, options[dbgOpt]);
};

var writeToFile = function(filename, data, success) {

  fs.writeFile(filename, data, function(err) {
    if(err) {
      return process.stderr.write(err.message);
    }
    else {
      return success();
    }
  });
}

var processFilenames = function(list, index, options) {

  let menuFilename = menuDir + path.parse(list[index]).name + '.xml'
  let attributeFilename = attributeDir + path.parse(list[index]).name + '.xml'
  let result = XSLTTranslation("../" + options[xmlOpt] + "/" + list[index], options);
  writeToFile(menuFilename, result['menuEntries'], function() {
    writeToFile(attributeFilename, result['attributeList'], function() {
      if (list.length > index+1) {
        processFilenames(list, index+1, options);
      }
      else {
        window.close();
      }
    });
  });
};

var parseOptions = function( done ) {

  let arguments = remote.getGlobal('sharedObject').prop1;
  let options = getOptions(arguments);
  if (options[xmlOpt] == null) {
    process.stderr.write('I need at least a directory for xml Files')
    window.close();
  }
  fs.readdir(options[xmlOpt], function(err, items) {
    if (err) {
      process.stderr.write(err.message)
    }
    else {
      processFilenames(items, 0, options);
    }
  });
};

</script>
</head>
<body onload="parseOptions()">
</body>
</html> 
